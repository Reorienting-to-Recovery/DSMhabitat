---
title: "Reorienting to Recovery Habitat"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{R2R-habitat}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  fig.dim = c(8, 6)
)
```

```{r setup, include = FALSE}
library(DSMhabitat)
library(tidyverse)
library(lubridate)
```

## Baseline Habitat Inputs 

Habitat inputs for the Reorienting to Recovery baseline model run include current DSMhabitat values:

-   [`DSMhabitat::fr_spawn`](https://cvpia-osc.github.io/DSMhabitat/reference/spawn.html)
-   [`DSMhabitat::fr_juv`](https://cvpia-osc.github.io/DSMhabitat/reference/juvenile.html)
-   [`DSMhabitat::fr_fry`](https://cvpia-osc.github.io/DSMhabitat/reference/fry.html)
-   [`DSMhabitat::fr_fp`](https://cvpia-osc.github.io/DSMhabitat/reference/floodplain.html)
-   [`DSMhabitat::delta_habitat`](https://cvpia-osc.github.io/DSMhabitat/reference/delta_habitat.html)

Plus additional habitat acres from recently completed or in progress habitat restoration projects.

### Project Catalog

The Reorienting to Recovery Planning team solicited input for the project catalog (via email, office hours, and one-on-one calls) from watershed associations, CDFW staff, DWR habitat workshop group and project proponents. They consolidated project lists received from CDFW and DWR into a Project Catalog of \~250 projects.

27 of the projects in the project catalog were identified for inclusion in the baseline based on the following criteria - at least one of the rulesets below must true:

-   The project has greater that 50% funding allocated to it
-   Environmental permitting for the project has been applied for and/ or granted
-   The project is under construction
-   The project or endeavor consists of a suite of management actions (e.g. re-operation of existing infrastructure) that are actively being considered by managers, have been approved, or are newly (within the last calendar year) being implemented

#### Fall Run Project Catalog Summary

FlowWest summarized the project catalog by run, tributary, and habitat type to find total acres of habitat added to each Tributary. The following table shows summarized habitat added to each tributary:

```{r, echo = FALSE, message = FALSE}
fall_summary <- read_csv("data-raw/R2R_baseline_habitat_inputs/R2R_project_catalog_fall_summary.csv") |> 
  select(Watershed = watershed, `Habitat Type` = habitat_type, 
         Run = run, `Total Acres` = total_acres) 

knitr::kable(fall_summary, table.attr = "style='width:100%;'")  |> 
  kableExtra::kable_styling(full_width = T)
```

### Methodology for integrating habitat projects into model SIT DSM inputs

The first step was to convert total project acres into usable area given the following assumptins:

-   Floodplain use 90% suitable
-   In channel use 10% suitable - low gradient (high gradient?)
-   Spawning use 12% suitable

Habitat values for projects were not given for specific flows. To combine project acres with existing habitat we used a scaling approach (figure 1).

![](images/Screenshot%202023-01-13%20at%203.40.52%20PM.png){width="636"}

#### 1) Calculate flow point of reference 

We generated two helper functions to calculate flow reference points for adding inchannel and floodplain habitat. 

##### Inchannel Point of Reference 

For inchannel habitat we use the median flow over the entire modeled period 1980 - 2000. Flow inputs come from CalSim II benchmark from the 2019 Itp and 2020 BiOp. `existing_cfs_median_comparison_plot` takes in `habitat_type`, `watershed`, `species`, and a `calsim_version` and returns the median flow. 

```{r, echo = FALSE, message = FALSE, warning = FALSE}
source("data-raw/R2R_baseline_habitat_inputs/generate_hab_helper_functions.R")
```

Example: Median flow for American River fall run inchannel rearing 

```{r}
existing_cfs_median_comparison_point("inchannel rearing", "American River", 
                                     "fr", 'biop_itp_2018_2019')
```
##### Floodplain Point of Reference 

For floodplain habitat we use the 2 year floodplan... 

#### 2) Calculation proportion increase of habitat at flow point of reference 


#### 3) Scale existing habitat up by proportion increase

### Baseline Habitat Plots 

#### Spawning Habitat 

```{r, echo = FALSE}
# Exploratory plot 
r_to_r_baseline_habitat <- DSMhabitat::fr_spawn$r_to_r_baseline |> 
  DSMhabitat::square_meters_to_acres()

sit_habitat <- DSMhabitat::fr_spawn$biop_itp_2018_2019 |> DSMhabitat::square_meters_to_acres()

spawn <- expand_grid(
  watershed = factor(DSMscenario::watershed_labels, 
                     levels = DSMscenario::watershed_labels),
  month = 1:12,
  year = 1979:2000) |> 
  arrange(year, month, watershed) |> 
  mutate(
    sit_habitat = as.vector(sit_habitat),
    r_to_r_baseline_habitat = as.vector(r_to_r_baseline_habitat)) |> 
  filter(watershed %in% c("American River", 
                          "Upper Sacramento River", 
                          "Paynes Creek", 
                          "Clear Creek"))

spawn |> 
  transmute(watershed, date = ymd(paste(year, month, 1)), 
            sit_habitat, r_to_r_baseline_habitat) |> 
  gather(version, acres, -watershed, -date)  |> 
  ggplot(aes(date, acres, color = version)) +
  geom_line(alpha = .75) + 
  # geom_col(position = 'dodge') +
  facet_wrap(~watershed, scales = 'free_y') + 
  theme_minimal() + 
  theme(legend.position = "bototm")


```

#### Inchannel Rearing Fry Habitat 

TODO make sure new Tuolumne inputs showing up in graphs 

```{r, echo = FALSE}
# Exploratory plot 
r_to_r_baseline_habitat <- DSMhabitat::fr_fry$r_to_r_baseline |> 
  DSMhabitat::square_meters_to_acres()

sit_habitat <- DSMhabitat::fr_fry$biop_itp_2018_2019 |> DSMhabitat::square_meters_to_acres()

ic_fry <- expand_grid(
  watershed = factor(DSMscenario::watershed_labels, 
                     levels = DSMscenario::watershed_labels),
  month = 1:12,
  year = 1980:2000) |> 
  arrange(year, month, watershed) |> 
  mutate(
    sit_habitat = as.vector(sit_habitat),
    r_to_r_baseline_habitat = as.vector(r_to_r_baseline_habitat)) |> 
  filter(watershed %in% c("American River", 
                          "Tuolumne River",
                          "Upper Sacramento River",
                          "Upper-mid Sacramento River"))

ic_fry|> 
  transmute(watershed, date = ymd(paste(year, month, 1)), 
            sit_habitat, r_to_r_baseline_habitat) |> 
  gather(version, acres, -watershed, -date)  |> 
  ggplot(aes(date, acres, color = version)) +
  geom_line(alpha = .75) + 
  # geom_col(position = 'dodge') +
  facet_wrap(~watershed, scales = 'free_y') + 
  theme_minimal() + 
  theme(legend.position = "bototm")
```


#### Inchannel Rearing Juvenile Habitat 

```{r, echo = FALSE}
r_to_r_baseline_habitat <- DSMhabitat::fr_juv$r_to_r_baseline |> 
  DSMhabitat::square_meters_to_acres()

sit_habitat <- DSMhabitat::fr_juv$biop_itp_2018_2019 |> DSMhabitat::square_meters_to_acres()

ic_juv <- expand_grid(
  watershed = factor(DSMscenario::watershed_labels, 
                     levels = DSMscenario::watershed_labels),
  month = 1:12,
  year = 1980:2000) |> 
  arrange(year, month, watershed) |> 
  mutate(
    sit_habitat = as.vector(sit_habitat),
    r_to_r_baseline_habitat = as.vector(r_to_r_baseline_habitat)) |> 
  filter(watershed %in% c("American River", 
                          "Tuolumne River",
                          "Upper Sacramento River",
                          "Upper-mid Sacramento River"
  ))

ic_juv |> 
  transmute(watershed, date = ymd(paste(year, month, 1)), 
            sit_habitat, r_to_r_baseline_habitat) |> 
  gather(version, acres, -watershed, -date)  |> 
  ggplot(aes(date, acres, color = version)) +
  geom_line(alpha = .75) + 
  # geom_col(position = 'dodge') +
  facet_wrap(~watershed, scales = 'free_y') + 
  theme_minimal() + 
  theme(legend.position = "bototm")
```

#### Floodplain Rearing Habitat

```{r, echo = FALSE}
r_to_r_baseline_habitat <- DSMhabitat::fr_fp$r_to_r_baseline |> 
  DSMhabitat::square_meters_to_acres()

sit_habitat <- DSMhabitat::fr_fp$biop_itp_2018_2019 |> DSMhabitat::square_meters_to_acres()

fp <- expand_grid(
  watershed = factor(DSMscenario::watershed_labels, 
                     levels = DSMscenario::watershed_labels),
  month = 1:12,
  year = 1980:2000) |> 
  arrange(year, month, watershed) |> 
  mutate(
    sit_habitat = as.vector(sit_habitat),
    r_to_r_baseline_habitat = as.vector(r_to_r_baseline_habitat)) |> 
  filter(watershed %in% c("Yuba River", "Lower-mid Sacramento River", "Tuolumne River"))

fp |> 
  transmute(watershed, date = ymd(paste(year, month, 1)), 
            sit_habitat, r_to_r_baseline_habitat) |> 
  filter(!(watershed %in% c('Sutter Bypass', 'Yolo Bypass'))) |> 
  gather(version, acres, -watershed, -date)  |> 
  ggplot(aes(date, acres, color = version)) +
  geom_line() + 
  # geom_col(position = 'dodge') +
  facet_wrap(~watershed, scales = 'free_y') + 
  theme_minimal() + 
  theme(legend.position = "bototm")
```

#### Delta Habitat 

```{r, echo = FALSE}
r_to_r_baseline_habitat <- DSMhabitat::delta_habitat$r_to_r_baseline[,, "North Delta"] |> 
  DSMhabitat::square_meters_to_acres()

sit_habitat <- DSMhabitat::delta_habitat$sit_input[,, "North Delta"] |> DSMhabitat::square_meters_to_acres()

delta <- expand_grid(
  watershed = "North Delta",
  month = 1:12,
  year = 1980:2000) |> 
  arrange(year, month, watershed) |> 
  mutate(
    sit_habitat = as.vector(sit_habitat),
    r_to_r_baseline_habitat = as.vector(r_to_r_baseline_habitat)) |> 
  filter(watershed %in% c("North Delta"))

delta |> 
  transmute(watershed, date = ymd(paste(year, month, 1)), 
            sit_habitat, r_to_r_baseline_habitat) |> 
  gather(version, acres, -watershed, -date)  |> 
  ggplot(aes(date, acres, color = version)) +
  geom_line() + 
  # geom_col(position = 'dodge') +
  facet_wrap(~watershed, scales = 'free_y') + 
  theme_minimal() + 
  theme(legend.position = "bototm")
```