---
title: "In-channel Rearing Suitability for High Gradient Reaches"
author: "Maddee Rubenson (FlowWest)"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: paper
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE, 
                      message = FALSE)

library(tidyverse)
library(lubridate)

```

## Introduction

This document provides details on the approach used to estimate an in-channel rearing suitable proportion value to be used in the theoretical maximum habitat process for the Reorienting to Recovery project. The approach uses a 2013 study by Stillwater Sciences, [*Modeling Habitat Capacity and Population Productivity for Spring-run Chinook Salmon and Steelhead in the Upper Yuba River Watershed*](http://www.ycwa-relicensing.com/Technical%20References/07%20-%20Threatened%20Endangered%20and%20Fully%20Protected%20Species/2012%20-%200221%20-%20Stillwater%20Sciences%20RIPPLE%20Report.pdf)[^1]*,* where the authors use the gradient of the North, South, and Middle Yuba River to calculate a proportion of the reach suitable for in-channel rearing at habitats (pool, riffle, and run) within the channel. The tables F-1, F-6, and 4-1 within the Stillwater Sciences report were used in this analysis.

[^1]: Stillwater Sciences. 2012. Modeling habitat capacity and population productivity for spring-run Chinook salmon and steelhead in the Upper Yuba River watershed. Technical Report. Prepared by Stillwater Sciences, Berkeley, California for National Marine Fisheries Service, Santa Rosa, California.

FlowWest used the process and data collected by Stillwater Sciences to develop an approach that can be used for all Reorienting to Recovery watersheds that are considered high gradient or valley foothills (outside of the [Habitat Quantification Tool](https://www.sfei.org/sites/default/files/biblio_files/SalmonHQT_UserGuide_2019.pdf) boundary and have a slope greater than 0.4%).

## Objectives

**Objective 1:** Compare an rough gradient estimation method, which involves dividing the reach length by the difference between the maximum and minimum elevations, and a more detailed approach that subdivides the reach length into smaller segments.

**Objective 2:** Calculate the total proportion suitable for North and Middle Yuba Rivers. Use this value and each reaches gradient class to determine an in-channel rearing proportion suitable that can be applied to other reaches within the same gradient class.

```{r include=FALSE}
# tables from the STillwater Sciences Report 
table_f_1 <- readxl::read_excel('yuba_inchannel_rearing_tables.xlsx', sheet = "table F-1") |> janitor::clean_names() 

knitr::kable(table_f_1, caption = "Table F-1")

table_f_6 <- readxl::read_excel('yuba_inchannel_rearing_tables.xlsx', sheet = "table F-6") |> janitor::clean_names() 

knitr::kable(table_f_6, caption = "Table F-6")


table_4_1 <- readxl::read_excel('yuba_inchannel_rearing_tables.xlsx', sheet = "table 4-1") |> janitor::clean_names() 

knitr::kable(table_4_1, caption = "Table 4-1")


```

## Methods

### Objective 1 - coarse vs. fine elevation estimate comparison

As channels steepen, the ratio of suitable salmonid in-channel habitat (pools, riffles, and runs) lessens. The percent of a channel suitable for in-channel rearing depends on how steep the reach is. A coarse elevation profile for each reach was calculated by dividing the elevation difference from top to bottom by the reach length. This is a much simpler approach than calculating the gradient with any finer granularity. A finer approach was used on Middle and North Yuba River to determine if the coarse estimate would be sufficient for this analysis.

#### Coarse gradient estimate

Estimate the elevation of the North and Middle Yuba Rivers by dividing the river length by the elevation difference of the highest and lowest points. The elevations were acquired using the reach definitions provided in Table 4-1.

$coarseGradient = (elevationHigh - elevationLow)/riverLength * 100$

```{r include=FALSE}

coarse_elevations <- data.frame('subbasin' = c("NY", "MY"), 
                         'elevation_low_ft' = c(1930, 1178), 
                         'elevation_high_ft' = c(4545, 4640)
                         ) |> 
  left_join(table_4_1) |> 
  mutate(length_ft = upstream_rm * 5280,
         gradient = (elevation_high_ft - elevation_low_ft)/length_ft * 100,
         channel_gradient = case_when(gradient < 1 ~ "0-1%",
                                      gradient > 1 & gradient < 2 ~ "1–2%",
                                      gradient > 2 & gradient < 4 ~ "2–4%",
                                      gradient > 4 & gradient < 8 ~ "4–8%",
                                      gradient > 8 ~  "8-12%"
                                      ))


knitr::kable(coarse_elevations, caption = "the composition of gradient classes within the Middle and North Yuba River, estimating gradient using the coarse approach of dividing the length by the maximum and minimum reach elevation difference", digits = 1)

```

#### Fine gradient estimates

FlowWest calculated channel gradient by intersecting the national hydrography dataset (NHD) channel network with digital elevation model (DEM) contours at 0.5 mile reaches. This process was done for the Middle and North Yuba River. The majority of each reach fell within the 0-1% gradient class.

```{r include=FALSE}
grads <- readxl::read_excel('Yuba_River_Elevations.xls') |> janitor::clean_names() |> glimpse()

grad_summary <- grads |> 
 # filter(gnis_name %in% c("North Yuba River", "Middle Yuba River")) |> 
  group_by(gnis_name) |> 
  summarise(elev_change = elevation_meters - lag(elevation_meters, 1),
            gradient = (elev_change/804.672) * 100 ,
            channel_gradient = case_when(gradient < 1 ~ "0-1%",
                                      gradient > 1 & gradient < 2 ~ "1–2%",
                                      gradient > 2 & gradient < 4 ~ "2–4%",
                                      gradient > 4 & gradient < 8 ~ "4–8%",
                                      gradient > 8 ~  ">8%"
                                      ))



perc_summary <- grad_summary |>
  group_by(channel_gradient, gnis_name) |> 
  summarise(n_lengths = n()) |> 
  ungroup() |> 
  group_by(gnis_name) |> 
  mutate(n_lengths_sum = sum(n_lengths),
            perc_total = n_lengths/n_lengths_sum * 100) |> 
  arrange(gnis_name, desc(perc_total)) |> 
  select(channel_gradient, subbasin = gnis_name, 
         perc_of_reach_in_gradient_class = perc_total) |> 
  filter(!is.na(channel_gradient))

knitr::kable(perc_summary, caption = "The composition of gradient classes within the Middle and North Yuba River where gradient is estimated at 0.5 mile reaches", digits = 1)

```

```{r echo=FALSE}

# the majority gradient class of each subbasin
gradient_summary_table <- perc_summary |> 
  group_by(subbasin) |> 
  mutate(majority_gradient_class = max(perc_of_reach_in_gradient_class)) |> 
  filter(perc_of_reach_in_gradient_class >= majority_gradient_class) |> 
  select(channel_gradient, subbasin) |> 
  mutate(subbasin = case_when(subbasin == "Middle Yuba River" ~ "MY",
                              subbasin == "North Yuba River" ~ "NY",
                              subbasin == "South Yuba River" ~ "SY")) |> 
  right_join(coarse_elevations |> 
                select(subbasin, description, coarse_gradient_class = channel_gradient)) |> 
  select(subbasin, description, fine_gradient_class = channel_gradient, coarse_gradient_class)

knitr::kable(gradient_summary_table, caption = "The channel gradients determined through the coarse and fine scale approach for the Middle and North Yuba River",  col.names = c('Subbasin', 'Description', 'Fine Gradient Class', 'Coarse Gradietn Class'))
```

Though variability exists between the coarse and fine gradients for the Middle and North Yuba River, we decided to use the coarse approach for the reaches within the R2R landscape. The in-channel rearing suitability is similar between these two gradient classes (see Table F-6 of the Stillwater Sciences report) and this process can be further refined later in this project if deemed necessary.

### Objective 2: calculate the total proportion suitable for each reach

For the Middle, North, and South Yuba River reaches the total proportion of the channel suitable for rearing was calculated using tables F-6, F-1 and 4-1 of the Stillwater Sciences report. Table F-1 defines the proportion habitat types (pool, riffle, run, cascade) by channel length for each channel gradient and subbasin. Table F-6 defines the usable fraction values for each habitat type and gradient combination and Table 4-1 provides reach length and contributing drainage area for each subbasin. The suitable proportion of in-channel rearing for each subbasin was defined as the product of habitat proportion suitable, usable fraction, and the contributing drainage area.

```{r echo=FALSE}

usable_area_formatting <- table_4_1 |> 
  expand(subbasin,  
         channel_gradient = unique(table_f_1$channel_gradient)) |> 
  left_join(table_f_1 |> 
               rename(subbasin = reach)) |> 
  pivot_longer(cols = c(pool, riffle, run, cascade), names_to = "habitat_type", 
               values_to = "habitat_proportion") |> 
  left_join(table_f_6 |> 
              mutate(channel_gradient =  c("0-1%",  "1–2%",  "2–4%",  "4–8%")) |> 
              pivot_longer(cols = c(pool, riffle, run), names_to = "habitat_type", 
                           values_to = "usable_proportion")) |> 
  filter(habitat_type != "cascade" & channel_gradient != '8–12%')  |> 
  left_join(table_4_1 |> 
              select(-downstream_rm, -upstream_rm))


total_suitable_perc <- usable_area_formatting  |> 
  group_by(subbasin, channel_gradient, habitat_type, contributing_area_km2) |> 
  summarise(usable_area_km2 = contributing_area_km2 * habitat_proportion * usable_proportion) |> 
  ungroup() |> 
  group_by(subbasin, channel_gradient) |> 
  summarise(total_suitable_perc = sum(usable_area_km2)/contributing_area_km2 * 100) 

total_in_channel_rearing <- total_suitable_perc |> 
  left_join(perc_summary |> 
              mutate(subbasin = case_when(subbasin == "Middle Yuba River" ~ "MY",
                                          subbasin == "North Yuba River" ~ "NY",
                                          subbasin == "South Yuba River" ~ "SY"))) |> 
  left_join(table_4_1 |> 
             select(-downstream_rm, -upstream_rm)) |> 
  filter(subbasin != 'NBB') |> distinct() |> 
  group_by(subbasin, contributing_area_km2) |> 
  mutate(perc_channel_with_grad_class = perc_of_reach_in_gradient_class/100 * total_suitable_perc,
         area_km2_by_habitat = perc_channel_with_grad_class/100 * contributing_area_km2) |> 
  distinct() |> 
  group_by(subbasin, contributing_area_km2) |> 
  summarise(total_habitat_area_km2 = sum(area_km2_by_habitat),
           total_in_channel_rearing_perc = (total_habitat_area_km2/contributing_area_km2) * 100) |>        
  distinct() |> ungroup() |> 
  select(subbasin, total_in_channel_rearing_perc)


knitr::kable(total_in_channel_rearing, caption = "in channel rearing % suitable based on gradient study in the Yuba River", digits = 1, col.names = c('Subbasin', 'Total In-channel Rearing (%)'))

```

Given the majority of the North, Middle and South Yuba River subbasins are within the 0-1% channel gradient, we will use the average, a `r round(mean(total_in_channel_rearing$total_in_channel_rearing_perc), 1)`% suitable for gradient class of 0-1%. As the channel steepens, the suitable area for in-channel rearing lessens. Following the usable fraction logic identified in Stillwater Sciences Table F-6, the following suitable in-channel rearing percentages will be used for the other gradient classes. These values can be used for all reaches that fall within each gradient class for the R2R project.

```{r echo=FALSE}

channel_grad_0_1 <- round(mean(total_in_channel_rearing$total_in_channel_rearing_perc))

all_gradients <- data.frame(channel_gradient = c("0-1%",  "1–2%",  "2–4%",  "4–8%"),
           perc_suitable_inchannel_rearing = c(channel_grad_0_1, 
                                               channel_grad_0_1, 
                                               channel_grad_0_1 * 0.75, 
                                               channel_grad_0_1 * 0.25))

knitr::kable(all_gradients, caption = "% suitable for in-channel rearing at all gradients", 
             col.names = c('Channel Gradient Class', 'Total In-channel Rearing (%)'))
```
